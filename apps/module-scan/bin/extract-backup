#!/usr/bin/env bash

set -euo pipefail

# e.g. election-a0eb9bf590-2020-09-23T01-41-38-773Z-backup.zip
BACKUP_FILE="${1:-}"

if [ -z "${BACKUP_FILE}" ]; then
  echo "usage: extract-backup BACKUP_FILE.zip" >&2
  exit 1
fi

BACKUP_DIR=$(realpath "${BACKUP_FILE%.*}")
mkdir -p "${BACKUP_DIR}"

MANIFEST_FILE="${BACKUP_DIR}/manifest"
zipinfo -1 "${BACKUP_FILE}" | grep -- "-original.png" | sort > "${MANIFEST_FILE}"

echo -e "\e[1mExtracting images…\e[0m"
unzip -o "${BACKUP_FILE}" "*.png" -d "${BACKUP_DIR}"

echo
echo -e "\e[1mExtracting database…\e[0m"
unzip -o "${BACKUP_FILE}" ballots.db -d "${BACKUP_DIR}"
[ -f "${BACKUP_DIR}/ballots.db.digest" ] || (shasum -a 256 schema.sql | cut -d " " -f 1 > "${BACKUP_DIR}/ballots.db.digest")

echo
echo -e "\e[1mSuccess! Your backup has been extracted.\e[0m"
echo -e "Restart module-scan/bsd to see the changes."
echo
echo -e "To re-scan the images using the UI, run this then restart module-scan/bsd in the same terminal:"
echo -e "$ \e[4mexport MOCK_SCANNER_FILES=@${MANIFEST_FILE}\e[0m"
echo
echo -e "To re-scan the images on the CLI, run this:"
echo -e "$ \e[4m./bin/retry-scan --all -i ${BACKUP_DIR}\e[0m"