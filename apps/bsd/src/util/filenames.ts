import moment from 'moment'

const SECTION_SEPERATOR = '__'
const SUBSECTION_SEPERATOR = '_'
const WORD_SEPERATOR = '-'
const TIME_FORMAT_STRING = `YYYY${WORD_SEPERATOR}MM${WORD_SEPERATOR}DD${SUBSECTION_SEPERATOR}HH${WORD_SEPERATOR}mm${WORD_SEPERATOR}ss`

export const BALLOT_PACKAGE_FOLDER = 'ballot-packages'

type ElectionData = {
  electionCounty: string
  electionName: string
  electionHash: string
  timestamp?: Date
}

/**
 * Convert an autogenerated name of the ballot configuration package zip archive
 * to the pieces of data contained in the name.
 */
export function parseBallotExportPackageInfoFromFilename(
  filename: string
): ElectionData | undefined {
  // There should be two underscores seperating the timestamp from the election information
  const segments = filename.split(SECTION_SEPERATOR)
  if (segments.length !== 2) {
    return
  }

  const [electionString, timeString] = segments

  let electionSegments = electionString.split(SUBSECTION_SEPERATOR)
  if (electionSegments.length !== 3) {
    return
  }
  electionSegments = electionSegments.map((s) => s.replace(/-/g, ' '))
  const [electionCounty, electionName, electionHash] = electionSegments

  const parsedTime = moment(timeString, TIME_FORMAT_STRING)
  return {
    electionCounty,
    electionName,
    electionHash,
    timestamp: parsedTime.toDate(),
  }
}
